<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NFT Marketplace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header, nav, main { padding: 1rem; }
    nav a { margin: 0 1rem; text-decoration: none; color: #007bff; }
    section { display: none; padding: 1rem; background: #fff; margin: 1rem; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    section.active { display: block; }
    .gift-card, .item-card { border: 1px solid #ddd; padding: 1rem; border-radius: 10px; margin: 1rem 0; background: #fafafa; }
    .gift-card img, .item-card img { width: 64px; height: 64px; }
    .admin-panel input, .admin-panel select, .admin-panel button { display: block; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <header>
    <h1>NFT Marketplace</h1>
    <nav>
      <a href="#" onclick="showSection('profile')">–ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="#" onclick="showSection('store')">–ú–∞–≥–∞–∑–∏–Ω</a>
      <a href="#" onclick="showSection('market')">–ú–∞—Ä–∫–µ—Ç</a>
      <a href="#" onclick="showSection('admin')">–ê–¥–º–∏–Ω</a>
    </nav>
  </header>

  <main>
    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <section id="profile" class="active">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <p>–ë–∞–ª–∞–Ω—Å: <strong id="balance">0 ‚≠ê</strong></p>
      <div id="user-gifts"></div>
    </section>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <section id="store">
      <h2>–ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤</h2>
      <div id="store-items"></div>
    </section>

    <!-- –ú–∞—Ä–∫–µ—Ç -->
    <section id="market">
      <h2>–ú–∞—Ä–∫–µ—Ç</h2>
      <p>–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –∏ –ø—Ä–æ–¥–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).</p>
    </section>

    <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
    <section id="admin">
      <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
      <div class="admin-panel">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h3>
        <form id="add-gift-form">
          <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞" required />
          <input type="number" name="price" placeholder="–¶–µ–Ω–∞" required />
          <input type="number" name="stock" placeholder="–û—Å—Ç–∞—Ç–æ–∫" required />
          <input type="file" name="file" accept=".tgs" required />
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>

        <h3>–ü—Ä–∏–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ ID</h3>
        <form id="add-stock-form">
          <input type="number" name="gift_id" placeholder="ID –ø–æ–¥–∞—Ä–∫–∞" required />
          <input type="number" name="amount" placeholder="–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å" required />
          <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>

        <h3>–î–æ–±–∞–≤–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫</h3>
        <form id="add-upgrade-form">
          <input type="number" name="gift_id" placeholder="ID –ø–æ–¥–∞—Ä–∫–∞" required />
          <input type="file" name="file" accept=".tgs" required />
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</button>
        </form>
      </div>
    </section>
  </main>

  <script>
    const API = 'http://localhost:8000';
    let USER_ID = null;
    const ADMIN_ID = 5000936733;

    async function initUser() {
      await fetch(`${API}/init_user?user_id=${USER_ID}`, { method: 'POST' });
    }

    async function loadProfile() {
      const res = await fetch(`${API}/profile/${USER_ID}`);
      const data = await res.json();
      document.getElementById('balance').textContent = `${data.balance} ‚≠ê`;
      const container = document.getElementById('user-gifts');
      container.innerHTML = '';
      data.gifts.forEach(g => {
        const div = document.createElement('div');
        div.className = 'gift-card';
        div.innerHTML = `üéÅ <strong>${g.gift_name}</strong> ‚Äî –£–ª—É—á—à–µ–Ω: ${g.upgraded ? '–î–∞' : '–ù–µ—Ç'} ${g.upgraded ? '' : `<button onclick="upgradeGift(${g.id})">–£–ª—É—á—à–∏—Ç—å</button>`}`;
        container.appendChild(div);
      });
    }

    async function loadStore() {
      const res = await fetch(`${API}/store`);
      const data = await res.json();
      const container = document.getElementById('store-items');
      container.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item-card';
        div.innerHTML = `
          <img src="${API}/${item.tgs_path}" alt="${item.name}" />
          <p><strong>${item.name}</strong><br>–¶–µ–Ω–∞: ${item.price} ‚≠ê<br>–û—Å—Ç–∞—Ç–æ–∫: ${item.stock}</p>
          <button onclick="buyGift(${item.id})">–ö—É–ø–∏—Ç—å</button>
        `;
        container.appendChild(div);
      });
    }

    async function buyGift(id) {
      await fetch(`${API}/buy/${USER_ID}/${id}`, { method: 'POST' });
      loadProfile();
      loadStore();
    }

    async function upgradeGift(id) {
      await fetch(`${API}/upgrade/${USER_ID}/${id}`, { method: 'POST' });
      loadProfile();
    }

    async function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'profile') loadProfile();
      if (id === 'store') loadStore();
    }

    document.getElementById('add-gift-form').onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      form.append('user_id', ADMIN_ID);
      await fetch(`${API}/admin/add_gift`, { method: 'POST', body: form });
      e.target.reset();
      alert('–ì–∏—Ñ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
    };

    document.getElementById('add-stock-form').onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      form.append('user_id', ADMIN_ID);
      await fetch(`${API}/admin/add_stock`, { method: 'POST', body: form });
      e.target.reset();
      alert('–û—Å—Ç–∞—Ç–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω');
    };

    document.getElementById('add-upgrade-form').onsubmit = async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      form.append('user_id', ADMIN_ID);
      await fetch(`${API}/admin/add_upgrade`, { method: 'POST', body: form });
      e.target.reset();
      alert('–£–ª—É—á—à–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    };

    window.onload = async () => {
      const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
      if (!tgUser) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
      }
      USER_ID = tgUser.id;
      await initUser();
      await loadProfile();
    };
  </script>
</body>
</html>
